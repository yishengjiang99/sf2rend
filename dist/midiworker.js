(()=>{"use strict";const t=async e=>{const s=await fetch(e),n=await s.arrayBuffer(),{ctrls:{run:r,rwd:a,pause:c},totalTicks:o,tracks:i,presets:f}=await async function(t,e){const{tracks:s,division:n,presets:r,ntracks:a}=function(t){const e=function(t){let e=0;const s=()=>t[e++];function n(){const t=s();return 32==t?" ":t>=65&&t<=122?"ABCDEFGHIJKLMNOPQRSTUVWXYZ......abcdefghijklmnopqrstuvwxyz".split("")[t-65]:t}return{get offset(){return e},set offset(t){e=t},fgetc:s,read32:()=>s()<<24|s()<<16|s()<<8|s(),read24:()=>s()<<16|s()<<8|s(),read16:()=>s()<<8|s(),readVarLength:function(){let t=0,e=s();for(t=127&e;128&e;)e=s(),t=t<<7|127&e;return t},readString:t=>{let e="";for(;t--;)e+=n();return e},btoa:n}}(t),{fgetc:s,btoa:n,read24:r,readString:a,read32:c,readVarLength:o,read16:i}=e,f=([n(),n(),n(),n()].join(""),c(),i(),i()),u=i(),l=[],h=t.byteLength;let d;function p(){const{fgetc:t,read24:s,readString:n,read32:r,readVarLength:a,read16:c}=e;let o=t();if(null==o)return[];if(240==(240&o))switch(o){case 255:return{meta:t(),payload:n(a())};case 240:case 247:return{sysex:n(a())};default:return{type:o,system:n(a())}}else{let e;switch(0==(128&o)?(e=o,o=d):(e=t(),d=o),o>>4){case 12:case 13:return{ch:15&o,cmd:(o>>4).toString(16),channel:[o,e,0]};default:return{ch:15&o,cmd:(o>>4).toString(16),channel:[o,e,t()]}}}}const g=[];for(;e.offset<h;){s(),s(),s(),s();let t=0;const n=c(),r=e.offset+n,a=[];for(;e.offset<r;){const s=o(),n=p();if(!n)break;if(n.eot)break;t+=s,n.channel&&n.channel[0]>>4==12&&g.push({t,channel:15&n.channel[0],pid:127&n.channel[1]});const r={offset:e.offset,t,delay:s,...n};a.push(r)}l.push(a),e.offset=r}return{division:u,tracks:l,ntracks:f,presets:g}}(t),c=n;let o=5e5,i=4,f=0;const u=s.map((t=>t[t.length-1])).reduce(((t,e)=>Math.max(e.t,t)),0),l=[];let h=0,d=0,p=!1;async function g(){for(;h<u;){for(let t in s){const n=s[t];if(n.length)for(;n.length&&n[0].t<h;){const s=n.shift();e(s),l.push({track:t,clockTime:d,...s}),s.tempo&&(o=s.tempo),s.timeSignature&&(i=s.timeSignature[0]/s.timeSignature[1]*4)}}if(p)break;const t=o/1e3/i;await new Promise((e=>setTimeout(e,t))),h+=c/i,d+=t/1e3,f++,e({clockTime:d,qn:f})}}return{ctrls:{pause:function(){p=!0},rwd:function(t){const e=[];for(;l.length&&l[l.unshift()].clockTime>d-t;)e.push(l.pop());for(h=e[0].tick,d-=t;e.length;)s[e[0].track].push(e.shift())},run:g,resume:function(){p=!1,g()}},tracks:s,ntracks:a,presets:r,totalTicks:u}}(new Uint8Array(n),postMessage);postMessage({totalTicks:o,presets:f});for(const t of i)for(const e of t){if(e.t>0)break;e.channel||postMessage(e)}onmessage=({data:{cmd:e,amt:s,url:n,evtPipe:o}})=>{switch(n&&(c(),t(n)),e){case"start":r();break;case"pause":c();break;case"resume":r();break;case"rwd":a(s||16)}}},e=self.location.hash.split("#")[1];console.log(e),t(e)})();